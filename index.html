<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plank — habit timer</title>
<style>
:root{--bg:#0b0b0b;--txt:#fff;--accent:#0a84ff;--danger:#ff453a;--ok:#23c7a4}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
.app{position:relative;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
.counter{position:absolute;top:50%;left:50%;transform:translate(-50%,-55%);font-weight:900;font-size:22vw;line-height:1;letter-spacing:1px}
@media (min-aspect-ratio:9/16){.counter{font-size:18vh}}
.controls{position:absolute;bottom:calc(env(safe-area-inset-bottom,0)+92px);left:50%;transform:translateX(-50%);display:flex;gap:18vw;align-items:center}
.sidebtn{width:72px;height:72px;border-radius:20px;border:3px solid #fff;display:flex;align-items:center;justify-content:center;user-select:none}
.sidebtn span{font-size:44px;margin-top:-2px}
.action{position:absolute;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0)+26px);width:112px;height:112px;border-radius:999px;border:2.5px solid #fff;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;color:#fff;background:var(--accent)}
.action.stop{background:var(--danger)}.action.again{background:var(--ok)}
.small{position:absolute;top:calc(env(safe-area-inset-top,0)+16px);right:16px;border:1.5px solid #fff;border-radius:999px;background:transparent;color:#fff;font-size:14px;padding:8px 12px}
.hidden{display:none}
.pre{position:absolute;inset:0;display:grid;place-items:center;background:var(--bg);z-index:5}
.pre h1{margin:0;font-weight:900;color:#fff;font-size:20vw}
@media (min-aspect-ratio:9/16){.pre h1{font-size:18vh}}
.done{position:absolute;top:50%;left:50%;transform:translate(-50%,-55%);font-weight:900;font-size:14vw;text-align:center;white-space:nowrap}
.feel{position:absolute;bottom:calc(env(safe-area-inset-bottom,0)+150px);left:50%;transform:translateX(-50%);display:flex;gap:10px}
.feel button{border:1.5px solid #fff;border-radius:12px;background:transparent;color:#fff;font-size:16px;padding:10px 12px}
</style></head><body>
<div class="app" id="app">
  <button id="btnExport" class="small">Export CSV</button>

  <div id="num" class="counter">20</div>

  <div id="controls" class="controls">
    <div id="minus" class="sidebtn"><span>−</span></div>
    <div id="plus"  class="sidebtn"><span>+</span></div>
  </div>

  <button id="btnStart" class="action">Start</button>
  <button id="btnStop"  class="action stop hidden">Stop</button>
  <button id="btnAgain" class="action again hidden">Again</button>

  <div id="pre" class="pre hidden"><h1 id="preTxt">Ready</h1></div>

  <div id="done" class="done hidden">Well done!</div>

  <div id="feel" class="feel hidden">
    <button data-f="easy">Easy</button>
    <button data-f="normal">Normal</button>
    <button data-f="hard">Hard</button>
  </div>
</div>

<script>
(()=>{
// ---------- UI ----------
const num=document.getElementById('num');
const controls=document.getElementById('controls');
const btnStart=document.getElementById('btnStart');
const btnStop=document.getElementById('btnStop');
const btnAgain=document.getElementById('btnAgain');
const btnExport=document.getElementById('btnExport');
const pre=document.getElementById('pre'); const preTxt=document.getElementById('preTxt');
const done=document.getElementById('done');
const feelBox=document.getElementById('feel');

// ---------- STATE ----------
let base=20; // стартовое время
let left=base;
let raf=null;
let sessionStartedAt=0;
let sessionTarget=0;
let finished=false;

// ---------- RENDER HELPERS ----------
const draw=v=>num.textContent=String(v);
const show=el=>el.classList.remove('hidden');
const hide=el=>el.classList.add('hidden');
draw(base);

// ---------- SOUND ----------
function beep(ms=120,f=880,v=0.06){try{
 const AC=window.AudioContext||window.webkitAudioContext; const ac=new AC();
 const o=ac.createOscillator(), g=ac.createGain(); o.frequency.value=f; g.gain.value=v;
 o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+ms/1000);
 setTimeout(()=>ac.close(),ms+60);
}catch(e){}}

// ---------- STORAGE (history) ----------
const KEY="plank.history.v1";
function readDB(){try{const raw=localStorage.getItem(KEY); if(!raw) return {v:1,items:[],lastSessionISO:null}; const db=JSON.parse(raw); if(!db.items) db.items=[]; return db;}catch{return {v:1,items:[],lastSessionISO:null}}}
function writeDB(db){try{localStorage.setItem(KEY,JSON.stringify(db));}catch{}}
function addRecord(rec){const db=readDB(); db.items.push(rec); if(db.items.length>1000) db.items=db.items.slice(-1000); db.lastSessionISO=new Date(rec.ts).toISOString().slice(0,10); writeDB(db);}
function exportCSV(){
  const {items}=readDB(); const rows=[["ts","date","target","done","ok","aborted","feeling"]];
  for(const x of items){const d=new Date(x.ts).toISOString(); rows.push([x.ts,d,x.target,x.done,x.ok,x.aborted,x.feeling||""]); }
  const csv=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="plank_history.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// ---------- DATES / MISSED DAYS ----------
const DAY=24*60*60*1000;
const todayISO=()=>new Date().toISOString().slice(0,10);
function diffDays(aISO,bISO){if(!aISO||!bISO)return 0; const a=new Date(aISO+"T00:00:00Z"),b=new Date(bISO+"T00:00:00Z"); return Math.floor((b-a)/DAY);}
function calcMissedDays(){const db=readDB(); if(!db.lastSessionISO)return 0; const d=diffDays(db.lastSessionISO,todayISO()); return Math.max(0,d-1);}

// ---------- ALGORITHM ----------
function applyDetraining(cur,miss){const k=Math.max(0.5,1-0.05*Math.max(0,miss)); return cur*k;}
function applyFeeling(sec,feeling){const k=feeling==="easy"?1.05:feeling==="hard"?0.95:1.0; return sec*k;}
function clampRound(sec){let t=Math.round(sec); if(t<10)t=10; if(t>300)t=300; return t;}
function computeNextPlankTime(currentSec,feeling,missedOverride){
  const missed=(typeof missedOverride==="number")?missedOverride:calcMissedDays();
  let next=applyDetraining(currentSec,missed);
  next=applyFeeling(next,feeling);
  return clampRound(next);
}
function logSession({target,done,feeling="normal",aborted=false}){const ok=!aborted&&done>=target; addRecord({ts:Date.now(),target,done,ok,aborted,feeling});}

// ---------- CONTROLS BEFORE START ----------
document.getElementById('minus').onclick=()=>{ if(!btnStart.classList.contains('hidden')){ base=Math.max(10,base-10); draw(base);} };
document.getElementById('plus').onclick =()=>{ if(!btnStart.classList.contains('hidden')){ base=Math.min(300,base+10); draw(base);} };
btnExport.onclick=exportCSV;

// ---------- PRECOUNT ----------
function runPreThenStart(){
  preTxt.textContent="Ready"; show(pre);
  setTimeout(()=>preTxt.textContent="Set",800);
  setTimeout(()=>preTxt.textContent="Go!",1600);
  setTimeout(()=>{ hide(pre); startTimer(); },2200);
}

// ---------- TIMER ----------
function startTimer(){
  sessionStartedAt=Date.now(); sessionTarget=base; finished=false;
  left=base; draw(left);
  hide(btnStart); show(btnStop); hide(done); hide(feelBox);
  controls.style.display='none';

  let t0=performance.now(), prev10=left;
  const loop=(t)=>{
    const elapsed=Math.min((t-t0)/1000, base);
    const leftNow=Math.max(base-Math.floor(elapsed),0);
    if(leftNow!==left){left=leftNow; draw(left);}
    if(left>0 && left%10===0 && left!==prev10){prev10=left; beep();}
    if(elapsed<base){raf=requestAnimationFrame(loop);} else {finish();}
  };
  raf=requestAnimationFrame(loop);
}
function finish(){
  finished=true;
  hide(btnStop);
  const b=()=>beep(); b(); setTimeout(b,220); setTimeout(b,440);
  show(done); show(btnAgain); show(feelBox); // попросим ощущение
}
function resetToStart(){
  if(raf) cancelAnimationFrame(raf);
  show(btnStart); hide(btnStop); hide(btnAgain); hide(pre); hide(done); hide(feelBox);
  controls.style.display=''; draw(base);
}

// ---------- FEELING CHOICE ----------
feelBox.addEventListener('click', (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const feeling=btn.dataset.f; // 'easy'|'normal'|'hard'
  // записываем результат сессии
  const doneSec = finished ? sessionTarget : (sessionTarget-left);
  const aborted = !finished;
  logSession({target:sessionTarget,done:doneSec,feeling,aborted});
  // считаем время на следующий раз
  base = computeNextPlankTime(base, feeling);
  resetToStart();
});

// ---------- BUTTONS ----------
btnStart.onclick=()=>{ runPreThenStart(); };
btnStop.onclick =()=>{ // Stop во время отсчёта: лог прерванной сессии
  const doneSec = sessionTarget - left;
  logSession({target:sessionTarget,done:doneSec,feeling:"hard",aborted:true});
  resetToStart();
};
btnAgain.onclick=()=>{ resetToStart(); };

})();
</script>
</body></html>
